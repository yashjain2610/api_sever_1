================================================================================
                    API SERVER CHANGES - 5th February 2026
================================================================================

SUMMARY
-------
Today we prepared the API server for live AWS deployment with two major changes:
1. Switched duplicate detection from L2 metric to IP (Inner Product) metric
2. Added batch-4 image generation for earrings (generates 4 images at once)


================================================================================
PART 1: BRANCHES CREATED
================================================================================

We created 2 new branches from the existing code:

+----------------------------------+--------------------------------------------+
| Branch Name                      | Purpose                                    |
+----------------------------------+--------------------------------------------+
| feature/image-gen-sequential     | One-by-one image generation + IP metric    |
| feature/image-gen-batch-4        | 4 images at once + IP metric (MERGED)      |
+----------------------------------+--------------------------------------------+

Branch that was merged to MAIN: feature/image-gen-batch-4

Repositories updated:
- https://github.com/yashjain2610/api_sever_1.git (origin)
- https://github.com/Inder-26/api_sever_1.git (inder)


================================================================================
PART 2: IP METRIC FOR DUPLICATE DETECTION
================================================================================

WHAT CHANGED:
-------------
Previously, we used L2 (Euclidean distance) to find duplicate images.
Now we use IP (Inner Product) metric which works better with normalized vectors.

WHY THIS CHANGE:
----------------
- IP metric with normalized vectors gives cosine similarity
- More accurate for image comparison
- Industry standard for CLIP embeddings


FILES CHANGED:
--------------

1. image_search_engine.py

   a) Collection name (line 35):
      OLD: COLLECTION_NAME = "image_embeddings"
      NEW: COLLECTION_NAME = "image_embeddings_ip"

   b) Embedding normalization (line 335-342):
      OLD: Just return raw embedding
      NEW: Normalize embedding for cosine similarity

      Code:
      ```python
      def embed_image(img, model, processor, device):
          inputs = processor(images=img, return_tensors="pt").to(device)
          with torch.no_grad():
              features = model.get_image_features(**inputs)
          emb = features.cpu().numpy().reshape(-1)
          # Normalize for IP metric
          emb = emb / np.linalg.norm(emb)
          return emb
      ```

   c) Index creation (line 366):
      OLD: "metric_type": "L2"
      NEW: "metric_type": "IP"

   d) Search function (line 537-548):
      OLD: Simple L2 search
      NEW: IP search with score conversion

      Code:
      ```python
      def search_similar(collection, query_emb, top_k=5):
          search_params = {"metric_type": "IP", "params": {"ef": 64}}
          results = collection.search(
              data=[query_emb.tolist()],
              anns_field="embedding",
              param=search_params,
              limit=top_k,
              output_fields=["id"]
          )
          # Convert: score ~1 = identical, ~0 = different
          # Return as (id, 1 - score) so lower = more similar
          return [(int(hit.id), 1 - float(hit.distance)) for hit in results[0]]
      ```

2. img_to_csv.py

   a) Collection name (line 73):
      OLD: collection_name = "image_embeddings"
      NEW: collection_name = "image_embeddings_ip"

   b) Threshold for duplicate detection (lines 531, 823):
      OLD: if dist < 95    (L2 distance)
      NEW: if dist < 0.05  (IP distance = ~95% similarity)


THRESHOLD EXPLANATION:
----------------------
+------------------+------------------+------------------------+
| Metric           | Duplicate If     | Meaning                |
+------------------+------------------+------------------------+
| L2 (old)         | dist < 95        | Euclidean distance     |
| IP (new)         | dist < 0.05      | 1 - similarity < 0.05  |
|                  |                  | = similarity > 0.95    |
|                  |                  | = 95% similar          |
+------------------+------------------+------------------------+


================================================================================
PART 3: BATCH-4 IMAGE GENERATION
================================================================================

WHAT CHANGED:
-------------
For earrings, instead of generating 1 image at a time, we now generate 4 images
at once by default.

IMAGE TYPES FOR EARRINGS:
-------------------------
+------+-------------------+------------------------------------------+
| Type | Name              | Description                              |
+------+-------------------+------------------------------------------+
|  1   | White Background  | Pure white background (Amazon main)      |
|  2   | Hand Holding      | Earrings on open human hand              |
|  3   | Dimension Image   | With height/width markings (SKIPPED)     |
|  4   | Lifestyle Nature  | Hanging on stick with leaves             |
|  5   | Model Wearing     | AI model wearing the earrings            |
+------+-------------------+------------------------------------------+

DEFAULT: Types [1, 2, 4, 5] - Type 3 (Dimension) is skipped by default


FILES CHANGED:
--------------

1. img_to_csv.py (lines 1609-1618)

   Added default image types:
   ```python
   class ImageRequest(BaseModel):
       s3_urls: str
       product_type: str
       num_images: int = 4  # Default 4 images
       image_types: List[int] = None
       height: str = None
       width: str = None

   # Default: skip type 3 (dimension image)
   DEFAULT_EARRING_IMAGE_TYPES = [1, 2, 4, 5]
   ```

2. prompts2.py (lines 709-780)

   Added EARRING_IMAGE_TYPES dictionary with prompts for each type.


FLOW DIAGRAM - Generate Images Endpoint:
----------------------------------------

    User Request (/generate-images)
           |
           v
    +------------------+
    | product_type     |
    | = "earring"?     |
    +------------------+
           |
      YES  |
           v
    +------------------+
    | image_types      |
    | provided?        |
    +------------------+
           |
    NO     |                YES
           v                  |
    +------------------+      |
    | Use default:     |      |
    | [1, 2, 4, 5]     |      |
    +------------------+      |
           |                  |
           v                  v
    +----------------------------------+
    | Generate 4 images:               |
    | - Type 1: White Background       |
    | - Type 2: Hand Holding           |
    | - Type 4: Lifestyle Nature       |
    | - Type 5: Model Wearing          |
    +----------------------------------+
           |
           v
    +------------------+
    | Upload to S3     |
    | Create ZIP file  |
    +------------------+
           |
           v
    Return: {
      original_image_url,
      gen_images: [...],
      zip_url
    }


================================================================================
PART 4: ENDPOINTS SUMMARY
================================================================================

1. /generate_caption (POST)
   -------------------------
   Purpose: Analyze jewelry image, detect duplicates, generate description

   Parameters:
   +------------------+----------+---------+---------------------------+
   | Parameter        | Type     | Default | Description               |
   +------------------+----------+---------+---------------------------+
   | file             | File     | Required| Jewelry image             |
   | type             | string   | Required| e.g., "earring"           |
   | website          | string   | "alya"  | S3 bucket (alya/blysk)    |
   | check_duplicate  | string   | "yes"   | "yes" or "no"             |
   +------------------+----------+---------+---------------------------+

   Response (New SKU):
   {
     "display_name": "original_filename.jpg",
     "generated_name": "AI_generated_name",
     "quality": "A",
     "description": "one-line caption",
     "attributes": "jewelry features",
     "prompt": "generation prompt",
     "color": "detected color",
     "s3_url": "https://..."
   }

   Response (Duplicate Found):
   {
     "display_name": "original_name.jpg",
     "s3_url": "https://existing_image...",
     "duplicate": "duplicate found"
   }


2. /image_similarity_search (POST)
   --------------------------------
   Purpose: Check if image is duplicate, upload if new

   Parameters:
   +------------------+----------+---------+---------------------------+
   | Parameter        | Type     | Default | Description               |
   +------------------+----------+---------+---------------------------+
   | file             | File     | Required| Image to check            |
   | top_k            | int      | 1       | Number of matches         |
   | website          | string   | "alya"  | S3 bucket                 |
   | check_duplicate  | string   | "yes"   | "yes" or "no"             |
   +------------------+----------+---------+---------------------------+

   Response (Duplicate):
   {
     "duplicate_found": true,
     "results": [{"id": 123, "distance": 0.02, "path": "https://..."}]
   }

   Response (New Image):
   {
     "duplicate_found": false,
     "image_name": "filename.jpg",
     "s3_url": "https://..."
   }


3. /generate-images (POST)
   ------------------------
   Purpose: Generate product images from original jewelry image

   Parameters:
   +------------------+----------+-----------+---------------------------+
   | Parameter        | Type     | Default   | Description               |
   +------------------+----------+-----------+---------------------------+
   | s3_urls          | string   | Required  | S3 URL of original image  |
   | product_type     | string   | Required  | "earring", "bracelet"...  |
   | num_images       | int      | 4         | Number of images          |
   | image_types      | list     | [1,2,4,5] | Which types to generate   |
   | height           | string   | null      | For type 3 only           |
   | width            | string   | null      | For type 3 only           |
   +------------------+----------+-----------+---------------------------+

   Response:
   {
     "original_image_url": "https://...",
     "gen_images": [
       {
         "prompt_index": 0,
         "image_url": "https://...",
         "image_type": 1,
         "image_type_name": "White Background"
       },
       ...
     ],
     "zip_url": "https://...zip"
   }


================================================================================
PART 5: DUPLICATE DETECTION FLOW
================================================================================

    Image Upload
         |
         v
    +------------------------+
    | check_duplicate="yes"? |
    +------------------------+
         |
    NO   |              YES
         |               |
         v               v
    Skip check     +------------------+
    Upload new     | Embed with CLIP  |
         |         | (normalized)     |
         |         +------------------+
         |               |
         |               v
         |         +------------------+
         |         | Search Milvus    |
         |         | (IP metric)      |
         |         +------------------+
         |               |
         |               v
         |         +------------------+
         |         | dist < 0.05?     |
         |         | (95% similar)    |
         |         +------------------+
         |               |
         |          YES  |  NO
         |               |   |
         |               v   v
         |         Return   Upload new
         |         duplicate image to S3
         |               |
         v               v
    +----------------------------------+
    |     Return S3 URL + metadata     |
    +----------------------------------+


================================================================================
PART 6: TESTING BEFORE DEPLOYMENT
================================================================================

1. Start the server:
   uvicorn img_to_csv:app --reload --host 0.0.0.0 --port 8000

2. Test /image_similarity_search:
   - Upload a new image -> should return duplicate_found: false
   - Upload same image again -> should return duplicate_found: true

3. Test /generate_caption:
   - Upload image with check_duplicate="yes" -> check duplicate detection
   - Upload image with check_duplicate="no" -> should skip and upload

4. Test /generate-images:
   - Send earring image -> should return 4 generated images
   - Check image_type in response: [1, 2, 4, 5]


================================================================================
PART 7: IMPORTANT NOTES FOR DEPLOYMENT
================================================================================

1. MILVUS COLLECTION:
   - New collection name: "image_embeddings_ip"
   - Old collection (L2): "image_embeddings"
   - You may need to re-index all images if switching metrics

2. ENVIRONMENT VARIABLES:
   - COLLECTION_NAME should be set to "image_embeddings_ip" for new metric
   - Or leave default in code

3. BACKWARDS COMPATIBILITY:
   - check_duplicate parameter works same as before
   - Dual bucket (alya/blysk) still supported
   - Response format unchanged


================================================================================
COMMITS MADE TODAY
================================================================================

1. 0ff1d92 - Add composite approach for 100% jewelry preservation
2. 3f2834d - Add image_types parameter for Amazon earrings catalog
3. 33bb046 - Add IP metric for duplicate detection
4. 8573238 - Add batch-4 image generation (skip dimension) [MERGED TO MAIN]


================================================================================
                              END OF DOCUMENT
================================================================================

# API Server Changes - 5th February 2026

## Summary

Today we prepared the API server for live AWS deployment with major improvements:

1. **IP Metric** - Switched duplicate detection from L2 to IP (Inner Product) metric
2. **Batch-4 Generation** - Added batch image generation for earrings (4 images at once)
3. **Parallel Execution** - 4x faster image generation using ThreadPoolExecutor (75s → 17s)
4. **Rate Limit Handling** - Retry logic with exponential backoff for 429 errors
5. **Error Resilience** - Graceful handling of failed image generations
6. **ZIP Download Fix** - S3 client authentication for private bucket access

---

## Table of Contents

1. [Branches Created](#1-branches-created)
2. [IP Metric for Duplicate Detection](#2-ip-metric-for-duplicate-detection)
3. [Batch-4 Image Generation](#3-batch-4-image-generation)
4. [Endpoints Summary](#4-endpoints-summary)
5. [Workflow Diagrams](#5-workflow-diagrams)
6. [Testing Guide](#6-testing-guide)
7. [Performance Optimizations](#7-performance-optimizations)
8. [Deployment Notes](#8-deployment-notes)

---

## 1. Branches Created

| Branch Name | Purpose | Status |
|-------------|---------|--------|
| `feature/image-gen-sequential` | One-by-one image generation + IP metric | Created |
| `feature/image-gen-batch-4` | 4 images at once + IP metric | **Merged to Main** |

**Repositories Updated:**
- https://github.com/yashjain2610/api_sever_1.git (origin)
- https://github.com/Inder-26/api_sever_1.git (inder)

---

## 2. IP Metric for Duplicate Detection

### What Changed?

| Aspect | Before (L2) | After (IP) |
|--------|-------------|------------|
| Metric Type | Euclidean Distance | Inner Product |
| Threshold | `dist < 95` | `dist < 0.05` |
| Collection | `image_embeddings` | `image_embeddings_ip` |
| Embeddings | Raw | Normalized |

### Why IP Metric?

```
┌─────────────────────────────────────────────────────────────┐
│                    L2 vs IP Comparison                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  L2 (Euclidean):     IP (Inner Product):                    │
│  ─────────────────   ───────────────────                    │
│  • Measures distance  • Measures similarity                 │
│  • Lower = similar    • Higher = similar                    │
│  • Range: 0 to ∞      • Range: -1 to 1 (normalized)         │
│  • Less accurate      • More accurate for CLIP              │
│    for CLIP vectors     embeddings                          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### Files Changed

#### 1. `image_search_engine.py`

**Line 35 - Collection Name:**
```python
# OLD
COLLECTION_NAME = os.getenv("COLLECTION_NAME", "image_embeddings")

# NEW
COLLECTION_NAME = os.getenv("COLLECTION_NAME", "image_embeddings_ip")
```

**Lines 335-342 - Embedding Normalization:**
```python
def embed_image(img, model, processor, device):
    inputs = processor(images=img, return_tensors="pt").to(device)
    with torch.no_grad():
        features = model.get_image_features(**inputs)
    emb = features.cpu().numpy().reshape(-1)

    # NEW: Normalize for IP metric (cosine similarity)
    emb = emb / np.linalg.norm(emb)
    return emb
```

**Line 366 - Index Creation:**
```python
# OLD
"metric_type": "L2"

# NEW
"metric_type": "IP"
```

**Lines 537-548 - Search Function:**
```python
def search_similar(collection, query_emb, top_k=5):
    search_params = {"metric_type": "IP", "params": {"ef": 64}}
    results = collection.search(
        data=[query_emb.tolist()],
        anns_field="embedding",
        param=search_params,
        limit=top_k,
        output_fields=["id"]
    )
    # Convert score to distance (1 - score)
    # So lower value = more similar (consistent with L2)
    return [(int(hit.id), 1 - float(hit.distance)) for hit in results[0]]
```

#### 2. `img_to_csv.py`

**Lines 531, 823 - Threshold Update:**
```python
# OLD
if dist < 95:  # L2 distance

# NEW
if dist < 0.05:  # IP distance (~95% similarity)
```

### Threshold Explanation

```
┌────────────────────────────────────────────────────────────────┐
│                    Similarity Threshold                        │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  IP Score = 1.0  ──────────────────────────── Identical        │
│       ↓                                                        │
│  IP Score = 0.95 ──────────────────────────── 95% Similar      │
│       ↓                                        (Duplicate)     │
│  IP Score = 0.90 ──────────────────────────── 90% Similar      │
│       ↓                                                        │
│  IP Score = 0.50 ──────────────────────────── 50% Similar      │
│       ↓                                        (Different)     │
│  IP Score = 0.0  ──────────────────────────── No Similarity    │
│                                                                │
│  ───────────────────────────────────────────────────────────── │
│                                                                │
│  We use: dist = 1 - score                                      │
│  So: dist < 0.05 means score > 0.95 (95% similar = duplicate)  │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

---

## 3. Batch-4 Image Generation

### What Changed?

For earrings, instead of generating 1 image at a time, we now generate **4 images at once** by default.

### Earring Image Types

| Type | Name | Description | Default? |
|------|------|-------------|----------|
| 1 | White Background | Pure white background (Amazon main image) | ✅ Yes |
| 2 | Hand Holding | Earrings resting on open human hand | ✅ Yes |
| 3 | Dimension Image | With height/width measurement markings | ❌ Skipped |
| 4 | Lifestyle Nature | Hanging on stick with leaves background | ✅ Yes |
| 5 | Model Wearing | AI-generated model wearing the earrings | ✅ Yes |

**Default Types:** `[1, 2, 4, 5]` - Type 3 (Dimension) is skipped by default

### Files Changed

#### `img_to_csv.py` (Lines 1609-1618)

```python
class ImageRequest(BaseModel):
    s3_urls: str
    product_type: str
    num_images: int = 4  # Default 4 images
    image_types: List[int] = None
    height: str = None  # For type 3 only
    width: str = None   # For type 3 only

# Default: skip type 3 (dimension image)
DEFAULT_EARRING_IMAGE_TYPES = [1, 2, 4, 5]
```

---

## 4. Endpoints Summary

### 4.1 `/generate_caption` (POST)

**Purpose:** Analyze jewelry image, detect duplicates, generate description

| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `file` | File | Required | Jewelry image |
| `type` | string | Required | e.g., "earring" |
| `website` | string | "alya" | S3 bucket (alya/blysk) |
| `check_duplicate` | string | "yes" | "yes" or "no" |

**Response (New SKU):**
```json
{
  "display_name": "original_filename.jpg",
  "generated_name": "AI_generated_name",
  "quality": "A",
  "description": "one-line caption",
  "attributes": "jewelry features",
  "prompt": "generation prompt",
  "color": "detected color",
  "s3_url": "https://alyaimg.s3.amazonaws.com/..."
}
```

**Response (Duplicate):**
```json
{
  "display_name": "original_name.jpg",
  "s3_url": "https://existing_image...",
  "duplicate": "duplicate found"
}
```

### 4.2 `/image_similarity_search` (POST)

**Purpose:** Check if image is duplicate, upload if new

| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `file` | File | Required | Image to check |
| `top_k` | int | 1 | Number of matches |
| `website` | string | "alya" | S3 bucket |
| `check_duplicate` | string | "yes" | "yes" or "no" |

**Response (Duplicate):**
```json
{
  "duplicate_found": true,
  "results": [{"id": 123, "distance": 0.02, "path": "https://..."}]
}
```

**Response (New):**
```json
{
  "duplicate_found": false,
  "image_name": "filename.jpg",
  "s3_url": "https://..."
}
```

### 4.3 `/generate-images` (POST)

**Purpose:** Generate product images from original jewelry image

| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `s3_urls` | string | Required | S3 URL of original image |
| `product_type` | string | Required | "earring", "bracelet", "necklace" |
| `num_images` | int | 4 | Number of images |
| `image_types` | list | [1,2,4,5] | Which types to generate |
| `height` | string | null | For type 3 only |
| `width` | string | null | For type 3 only |

**Response:**
```json
{
  "original_image_url": "https://...",
  "gen_images": [
    {
      "prompt_index": 0,
      "image_url": "https://...",
      "image_type": 1,
      "image_type_name": "White Background"
    }
  ],
  "zip_url": "https://...zip"
}
```

---

## 5. Workflow Diagrams

### 5.1 Duplicate Detection Flow

```
                              ┌─────────────────┐
                              │  Image Upload   │
                              └────────┬────────┘
                                       │
                                       ▼
                         ┌─────────────────────────┐
                         │ check_duplicate = "yes"? │
                         └─────────────┬───────────┘
                                       │
                    ┌──────────────────┴───────────────────┐
                    │                                      │
                    ▼ NO                                   ▼ YES
         ┌─────────────────┐                    ┌─────────────────┐
         │  Skip Check     │                    │ Embed with CLIP │
         │  Upload to S3   │                    │  (Normalized)   │
         └────────┬────────┘                    └────────┬────────┘
                  │                                      │
                  │                                      ▼
                  │                             ┌─────────────────┐
                  │                             │  Search Milvus  │
                  │                             │   (IP Metric)   │
                  │                             └────────┬────────┘
                  │                                      │
                  │                                      ▼
                  │                             ┌─────────────────┐
                  │                             │  dist < 0.05?   │
                  │                             │ (95% similar?)  │
                  │                             └────────┬────────┘
                  │                                      │
                  │                      ┌───────────────┴───────────────┐
                  │                      │                               │
                  │                      ▼ YES                           ▼ NO
                  │           ┌─────────────────┐             ┌─────────────────┐
                  │           │    DUPLICATE    │             │   Upload New    │
                  │           │  Return existing│             │   Image to S3   │
                  │           │     S3 URL      │             └────────┬────────┘
                  │           └────────┬────────┘                      │
                  │                    │                               │
                  └────────────────────┼───────────────────────────────┘
                                       │
                                       ▼
                              ┌─────────────────┐
                              │ Return Response │
                              │  with S3 URL    │
                              └─────────────────┘
```

### 5.2 Generate Images Flow (Batch-4)

```
                              ┌─────────────────┐
                              │   API Request   │
                              │ /generate-images│
                              └────────┬────────┘
                                       │
                                       ▼
                         ┌──────────────────────────┐
                         │ product_type = "earring"?│
                         └─────────────┬────────────┘
                                       │
                    ┌──────────────────┴───────────────────┐
                    │                                      │
                    ▼ YES                                  ▼ NO
         ┌─────────────────┐                    ┌─────────────────┐
         │ image_types     │                    │ Use old prompt  │
         │ provided?       │                    │ system for      │
         └────────┬────────┘                    │ bracelet/neck   │
                  │                             └────────┬────────┘
       ┌──────────┴──────────┐                           │
       │                     │                           │
       ▼ YES                 ▼ NO                        │
┌─────────────┐    ┌─────────────────┐                   │
│ Use custom  │    │ Use default:    │                   │
│ image_types │    │ [1, 2, 4, 5]    │                   │
└──────┬──────┘    └────────┬────────┘                   │
       │                    │                            │
       └────────────────────┼────────────────────────────┘
                            │
                            ▼
              ┌───────────────────────────┐
              │   Fetch Original Image    │
              │        from S3            │
              └─────────────┬─────────────┘
                            │
                            ▼
              ┌───────────────────────────┐
              │  Generate Images (GPT)    │
              │  For each image_type:     │
              │  ├─ Type 1: White BG      │
              │  ├─ Type 2: Hand Holding  │
              │  ├─ Type 4: Lifestyle     │
              │  └─ Type 5: Model Wearing │
              └─────────────┬─────────────┘
                            │
                            ▼
              ┌───────────────────────────┐
              │   Upload to S3 + Create   │
              │        ZIP File           │
              └─────────────┬─────────────┘
                            │
                            ▼
              ┌───────────────────────────┐
              │      Return Response      │
              │  • gen_images: [...]      │
              │  • zip_url: "https://..." │
              └───────────────────────────┘
```

### 5.3 Caption Generation Flow

```
                              ┌─────────────────┐
                              │   API Request   │
                              │/generate_caption│
                              └────────┬────────┘
                                       │
                                       ▼
                         ┌─────────────────────────┐
                         │  Select S3 Bucket       │
                         │  (alya or blysk)        │
                         └─────────────┬───────────┘
                                       │
                                       ▼
                         ┌──────────────────────────┐
                         │ check_duplicate = "yes"? │
                         └─────────────┬────────────┘
                                       │
                    ┌──────────────────┴───────────────────┐
                    │ NO                                   │ YES
                    ▼                                      ▼
         ┌─────────────────┐                    ┌─────────────────┐
         │  Skip duplicate │                    │ Run duplicate   │
         │  check          │                    │ detection       │
         └────────┬────────┘                    └────────┬────────┘
                  │                                      │
                  │                           ┌──────────┴──────────┐
                  │                           │                     │
                  │                           ▼ DUPLICATE           ▼ NEW
                  │                ┌─────────────────┐    ┌─────────────────┐
                  │                │ Return existing │    │  Continue...    │
                  │                │ URL + "duplicate│    └────────┬────────┘
                  │                │ found"          │             │
                  │                └─────────────────┘             │
                  │                                                │
                  └────────────────────────────────────────────────┤
                                                                   │
                                       ┌───────────────────────────┘
                                       │
                                       ▼
                         ┌─────────────────────────┐
                         │    Upload to S3         │
                         │  (timestamp filename)   │
                         └─────────────┬───────────┘
                                       │
                                       ▼
                         ┌─────────────────────────┐
                         │   Index in Milvus       │
                         │   (for future search)   │
                         └─────────────┬───────────┘
                                       │
                                       ▼
                         ┌─────────────────────────┐
                         │   Analyze with Gemini   │
                         │   • Quality (A/B/C)     │
                         │   • Name                │
                         │   • Description         │
                         │   • Attributes          │
                         │   • Color               │
                         └─────────────┬───────────┘
                                       │
                                       ▼
                         ┌─────────────────────────┐
                         │    Return Response      │
                         │  {display_name, ...}    │
                         └─────────────────────────┘
```

### 5.4 Overall System Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              API SERVER                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐   │
│  │  /generate  │    │  /image_    │    │  /generate- │    │  /delete_   │   │
│  │  _caption   │    │  similarity │    │  images     │    │  image      │   │
│  │             │    │  _search    │    │             │    │             │   │
│  └──────┬──────┘    └──────┬──────┘    └──────┬──────┘    └──────┬──────┘   │
│         │                  │                  │                  │          │
│         └──────────────────┼──────────────────┼──────────────────┘          │
│                            │                  │                             │
│                            ▼                  ▼                             │
│              ┌─────────────────────────────────────────┐                    │
│              │           Core Services                  │                   │
│              ├─────────────────────────────────────────┤                    │
│              │  • CLIP Model (Image Embedding)         │                    │
│              │  • Gemini AI (Caption Generation)       │                    │
│              │  • GPT Image (Image Generation)         │                    │
│              └─────────────────────────────────────────┘                    │
│                            │                                                │
└────────────────────────────┼────────────────────────────────────────────────┘
                             │
          ┌──────────────────┼──────────────────┐
          │                  │                  │
          ▼                  ▼                  ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│   Milvus/Zilliz │ │    AWS S3       │ │   JSON Files    │
│  (Vector DB)    │ │  (Image Store)  │ │  (Hash Maps)    │
├─────────────────┤ ├─────────────────┤ ├─────────────────┤
│ • IP Metric     │ │ • alyaimg       │ │ • indexed_      │
│ • HNSW Index    │ │ • blyskimg      │ │   hashes.json   │
│ • 512-dim       │ │ • gen_images/   │ │ • int_hash_to_  │
│   vectors       │ │                 │ │   path.json     │
└─────────────────┘ └─────────────────┘ └─────────────────┘
```

---

## 6. Testing Guide

### Minimum Tests Before Deployment

| # | Test | Command | Expected |
|---|------|---------|----------|
| 1 | New image upload | `curl -X POST .../image_similarity_search -F "file=@new.jpg"` | `duplicate_found: false` |
| 2 | Duplicate detection | Upload same image again | `duplicate_found: true` |
| 3 | Caption generation | `curl -X POST .../generate_caption -F "file=@img.jpg" -F "type=earring"` | Full JSON response |
| 4 | Batch-4 generation | `curl -X POST .../generate-images -d '{"s3_urls":"...", "product_type":"earring"}'` | 4 images + ZIP |
| 5 | IP distance check | Check server logs | Distance values 0-1 range |

### Start Server

```bash
uvicorn img_to_csv:app --reload --host 0.0.0.0 --port 8000
```

---

## 7. Performance Optimizations

### 7.1 Parallel Image Generation

**Problem:** Sequential generation of 4 images took ~75 seconds (each image ~15-20s).

**Solution:** Implemented `ThreadPoolExecutor` for parallel API calls.

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    BEFORE (Sequential) vs AFTER (Parallel)                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  BEFORE (Sequential):                                                       │
│  ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐                     │
│  │ Image 1 │───│ Image 2 │───│ Image 3 │───│ Image 4 │  = ~75 seconds      │
│  │  ~15s   │   │  ~15s   │   │  ~15s   │   │  ~15s   │                     │
│  └─────────┘   └─────────┘   └─────────┘   └─────────┘                     │
│                                                                             │
│  AFTER (Parallel):                                                          │
│  ┌─────────┐                                                                │
│  │ Image 1 │───┐                                                            │
│  └─────────┘   │                                                            │
│  ┌─────────┐   │                                                            │
│  │ Image 2 │───┼──► All finish at ~17s = ~17 seconds total                 │
│  └─────────┘   │                                                            │
│  ┌─────────┐   │                                                            │
│  │ Image 3 │───┤                                                            │
│  └─────────┘   │                                                            │
│  ┌─────────┐   │                                                            │
│  │ Image 4 │───┘                                                            │
│  └─────────┘                                                                │
│                                                                             │
│  Speedup: 75s → 17s = 4.4x faster                                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

**Files Changed:**

#### `utils2.py` - ThreadPoolExecutor Implementation

```python
from concurrent.futures import ThreadPoolExecutor, as_completed

def generate_images_from_gpt(image, prompts, size="1024x1024"):
    # Prepare args for parallel execution
    args_list = [(prompt, img_bytes, size, idx) for idx, prompt in enumerate(prompts)]

    # Execute in parallel with 4 workers
    with ThreadPoolExecutor(max_workers=4) as executor:
        futures = {
            executor.submit(_generate_single_image, args): args[3]
            for args in args_list
        }
        for future in as_completed(futures):
            result = future.result()
            all_responses[prompt_index] = result
```

### 7.2 Timing Logs

Added detailed timing logs to identify bottlenecks:

```
============================================================
[BATCH] Starting generation of 4 images
[BATCH] Start time: 16:12:26
============================================================
[BATCH] Image preparation: 0.02s (size: 255.3 KB)
[IMAGE 0] Started at 16:12:26
[IMAGE 0] Buffer creation: 0.00s
[IMAGE 0] API call (upload+process+download): 13.33s
[IMAGE 0] Decode response: 0.02s
[IMAGE 0] TOTAL: 13.35s
[IMAGE 0] Finished at 16:12:40
--------------------------------------------------
... (similar for images 1-3)
============================================================
[BATCH] All 4 images completed
[BATCH] End time: 16:12:41
[BATCH] TOTAL BATCH TIME: 14.85s
[BATCH] Sequential would be: 55.76s
[BATCH] Parallelization speedup: 3.8x
============================================================
```

**Timing Breakdown:**
| Step | Time | Notes |
|------|------|-------|
| Buffer creation | 0.00s | Instant |
| API call | 12-17s | **Bottleneck** (OpenAI processing) |
| Decode response | 0.00s | Instant |

### 7.3 Rate Limit Handling (429 Errors)

**Problem:** OpenAI has a limit of 5 input-images per minute. Parallel requests can exceed this.

**Solution:** Added retry logic with exponential backoff.

```python
def _generate_single_image(args):
    max_retries = 3
    base_delay = 15  # seconds

    for attempt in range(max_retries):
        try:
            result = client.images.edit(**api_params)
            break  # Success
        except Exception as e:
            if "429" in str(e) or "rate_limit" in str(e).lower():
                delay = base_delay * (attempt + 1)  # 15s, 30s, 45s
                print(f"[IMAGE {idx}] Rate limit hit, waiting {delay}s...")
                time.sleep(delay)
            else:
                raise  # Non-rate-limit error
```

**Retry Schedule:**
| Attempt | Wait Time |
|---------|-----------|
| 1 | 15 seconds |
| 2 | 30 seconds |
| 3 | 45 seconds |

### 7.4 Graceful Error Handling

**Problem:** When image generation fails, `images` list is empty causing `IndexError`.

**Solution:** Skip failed images gracefully instead of crashing.

```python
# img_to_csv.py - Line 1736
for i, item in enumerate(responses):
    # Skip failed generations
    if not item.get("images"):
        print(f"[WARNING] Skipping image {i} - generation failed")
        continue

    img_bytes = item["images"][0]
    # ... continue processing
```

### 7.5 ZIP Download Fix (S3 Client)

**Problem:** `/regenerate-image` endpoint failed with "Failed to download original zip" because S3 bucket is private.

**Solution:** Use boto3 S3 client with AWS credentials instead of HTTP requests.

```python
# BEFORE (Failed - bucket is private)
response = requests.get(zip_url)
zip_content = response.content

# AFTER (Works - authenticated access)
bucket_name = parsed.netloc.split('.')[0]  # e.g., "alyaimg"
zip_key = parsed.path.lstrip('/')
zip_obj = s3.get_object(Bucket=bucket_name, Key=zip_key)
zip_content = zip_obj['Body'].read()
```

---

## 8. Deployment Notes

### Important Reminders

| Item | Note |
|------|------|
| **Milvus Collection** | New collection: `image_embeddings_ip` |
| **Re-indexing** | May need to re-index all images for IP metric |
| **Environment** | Set `COLLECTION_NAME=image_embeddings_ip` |
| **Backwards Compatible** | `check_duplicate` and dual-bucket still work |

### Commits Made Today

| Commit | Description |
|--------|-------------|
| `0ff1d92` | Add composite approach for 100% jewelry preservation |
| `3f2834d` | Add image_types parameter for Amazon earrings catalog |
| `33bb046` | Add IP metric for duplicate detection |
| `8573238` | Add batch-4 image generation (skip dimension) |
| `0cc3fc7` | Add documentation |
| `2cc0a1d` | Add README.md with API documentation |
| `47a70f5` | Fix regenerate-image ZIP download error (S3 client) |
| `b0f764b` | Add parallel execution for image generation (~4x faster) |
| `c1b45eb` | Add timing logs for parallel image generation |
| `f7a6ede` | Fix rate limit handling with retry logic |

---

*Document created: 5th February 2026*
*Last updated: 5th February 2026*

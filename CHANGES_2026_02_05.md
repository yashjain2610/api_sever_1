# API Server Changes - 5th February 2026

## Summary

Today we prepared the API server for live AWS deployment with two major changes:
1. **IP Metric** - Switched duplicate detection from L2 to IP (Inner Product) metric
2. **Batch-4 Generation** - Added batch image generation for earrings (4 images at once)

---

## Table of Contents

1. [Branches Created](#1-branches-created)
2. [IP Metric for Duplicate Detection](#2-ip-metric-for-duplicate-detection)
3. [Batch-4 Image Generation](#3-batch-4-image-generation)
4. [Endpoints Summary](#4-endpoints-summary)
5. [Workflow Diagrams](#5-workflow-diagrams)
6. [Testing Guide](#6-testing-guide)
7. [Deployment Notes](#7-deployment-notes)

---

## 1. Branches Created

| Branch Name | Purpose | Status |
|-------------|---------|--------|
| `feature/image-gen-sequential` | One-by-one image generation + IP metric | Created |
| `feature/image-gen-batch-4` | 4 images at once + IP metric | **Merged to Main** |

**Repositories Updated:**
- https://github.com/yashjain2610/api_sever_1.git (origin)
- https://github.com/Inder-26/api_sever_1.git (inder)

---

## 2. IP Metric for Duplicate Detection

### What Changed?

| Aspect | Before (L2) | After (IP) |
|--------|-------------|------------|
| Metric Type | Euclidean Distance | Inner Product |
| Threshold | `dist < 95` | `dist < 0.05` |
| Collection | `image_embeddings` | `image_embeddings_ip` |
| Embeddings | Raw | Normalized |

### Why IP Metric?

```
┌─────────────────────────────────────────────────────────────┐
│                    L2 vs IP Comparison                       │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  L2 (Euclidean):     IP (Inner Product):                    │
│  ─────────────────   ───────────────────                    │
│  • Measures distance  • Measures similarity                  │
│  • Lower = similar    • Higher = similar                     │
│  • Range: 0 to ∞      • Range: -1 to 1 (normalized)         │
│  • Less accurate      • More accurate for CLIP              │
│    for CLIP vectors     embeddings                          │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### Files Changed

#### 1. `image_search_engine.py`

**Line 35 - Collection Name:**
```python
# OLD
COLLECTION_NAME = os.getenv("COLLECTION_NAME", "image_embeddings")

# NEW
COLLECTION_NAME = os.getenv("COLLECTION_NAME", "image_embeddings_ip")
```

**Lines 335-342 - Embedding Normalization:**
```python
def embed_image(img, model, processor, device):
    inputs = processor(images=img, return_tensors="pt").to(device)
    with torch.no_grad():
        features = model.get_image_features(**inputs)
    emb = features.cpu().numpy().reshape(-1)

    # NEW: Normalize for IP metric (cosine similarity)
    emb = emb / np.linalg.norm(emb)
    return emb
```

**Line 366 - Index Creation:**
```python
# OLD
"metric_type": "L2"

# NEW
"metric_type": "IP"
```

**Lines 537-548 - Search Function:**
```python
def search_similar(collection, query_emb, top_k=5):
    search_params = {"metric_type": "IP", "params": {"ef": 64}}
    results = collection.search(
        data=[query_emb.tolist()],
        anns_field="embedding",
        param=search_params,
        limit=top_k,
        output_fields=["id"]
    )
    # Convert score to distance (1 - score)
    # So lower value = more similar (consistent with L2)
    return [(int(hit.id), 1 - float(hit.distance)) for hit in results[0]]
```

#### 2. `img_to_csv.py`

**Lines 531, 823 - Threshold Update:**
```python
# OLD
if dist < 95:  # L2 distance

# NEW
if dist < 0.05:  # IP distance (~95% similarity)
```

### Threshold Explanation

```
┌────────────────────────────────────────────────────────────────┐
│                    Similarity Threshold                         │
├────────────────────────────────────────────────────────────────┤
│                                                                 │
│  IP Score = 1.0  ──────────────────────────── Identical        │
│       ↓                                                         │
│  IP Score = 0.95 ──────────────────────────── 95% Similar      │
│       ↓                                        (Duplicate)      │
│  IP Score = 0.90 ──────────────────────────── 90% Similar      │
│       ↓                                                         │
│  IP Score = 0.50 ──────────────────────────── 50% Similar      │
│       ↓                                        (Different)      │
│  IP Score = 0.0  ──────────────────────────── No Similarity    │
│                                                                 │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  We use: dist = 1 - score                                       │
│  So: dist < 0.05 means score > 0.95 (95% similar = duplicate)  │
│                                                                 │
└────────────────────────────────────────────────────────────────┘
```

---

## 3. Batch-4 Image Generation

### What Changed?

For earrings, instead of generating 1 image at a time, we now generate **4 images at once** by default.

### Earring Image Types

| Type | Name | Description | Default? |
|------|------|-------------|----------|
| 1 | White Background | Pure white background (Amazon main image) | ✅ Yes |
| 2 | Hand Holding | Earrings resting on open human hand | ✅ Yes |
| 3 | Dimension Image | With height/width measurement markings | ❌ Skipped |
| 4 | Lifestyle Nature | Hanging on stick with leaves background | ✅ Yes |
| 5 | Model Wearing | AI-generated model wearing the earrings | ✅ Yes |

**Default Types:** `[1, 2, 4, 5]` - Type 3 (Dimension) is skipped by default

### Files Changed

#### `img_to_csv.py` (Lines 1609-1618)

```python
class ImageRequest(BaseModel):
    s3_urls: str
    product_type: str
    num_images: int = 4  # Default 4 images
    image_types: List[int] = None
    height: str = None  # For type 3 only
    width: str = None   # For type 3 only

# Default: skip type 3 (dimension image)
DEFAULT_EARRING_IMAGE_TYPES = [1, 2, 4, 5]
```

---

## 4. Endpoints Summary

### 4.1 `/generate_caption` (POST)

**Purpose:** Analyze jewelry image, detect duplicates, generate description

| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `file` | File | Required | Jewelry image |
| `type` | string | Required | e.g., "earring" |
| `website` | string | "alya" | S3 bucket (alya/blysk) |
| `check_duplicate` | string | "yes" | "yes" or "no" |

**Response (New SKU):**
```json
{
  "display_name": "original_filename.jpg",
  "generated_name": "AI_generated_name",
  "quality": "A",
  "description": "one-line caption",
  "attributes": "jewelry features",
  "prompt": "generation prompt",
  "color": "detected color",
  "s3_url": "https://alyaimg.s3.amazonaws.com/..."
}
```

**Response (Duplicate):**
```json
{
  "display_name": "original_name.jpg",
  "s3_url": "https://existing_image...",
  "duplicate": "duplicate found"
}
```

### 4.2 `/image_similarity_search` (POST)

**Purpose:** Check if image is duplicate, upload if new

| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `file` | File | Required | Image to check |
| `top_k` | int | 1 | Number of matches |
| `website` | string | "alya" | S3 bucket |
| `check_duplicate` | string | "yes" | "yes" or "no" |

**Response (Duplicate):**
```json
{
  "duplicate_found": true,
  "results": [{"id": 123, "distance": 0.02, "path": "https://..."}]
}
```

**Response (New):**
```json
{
  "duplicate_found": false,
  "image_name": "filename.jpg",
  "s3_url": "https://..."
}
```

### 4.3 `/generate-images` (POST)

**Purpose:** Generate product images from original jewelry image

| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `s3_urls` | string | Required | S3 URL of original image |
| `product_type` | string | Required | "earring", "bracelet", "necklace" |
| `num_images` | int | 4 | Number of images |
| `image_types` | list | [1,2,4,5] | Which types to generate |
| `height` | string | null | For type 3 only |
| `width` | string | null | For type 3 only |

**Response:**
```json
{
  "original_image_url": "https://...",
  "gen_images": [
    {
      "prompt_index": 0,
      "image_url": "https://...",
      "image_type": 1,
      "image_type_name": "White Background"
    }
  ],
  "zip_url": "https://...zip"
}
```

---

## 5. Workflow Diagrams

### 5.1 Duplicate Detection Flow

```
                              ┌─────────────────┐
                              │  Image Upload   │
                              └────────┬────────┘
                                       │
                                       ▼
                         ┌─────────────────────────┐
                         │ check_duplicate = "yes"? │
                         └─────────────┬───────────┘
                                       │
                    ┌──────────────────┴──────────────────┐
                    │                                      │
                    ▼ NO                                   ▼ YES
         ┌─────────────────┐                    ┌─────────────────┐
         │  Skip Check     │                    │ Embed with CLIP │
         │  Upload to S3   │                    │  (Normalized)   │
         └────────┬────────┘                    └────────┬────────┘
                  │                                      │
                  │                                      ▼
                  │                             ┌─────────────────┐
                  │                             │  Search Milvus  │
                  │                             │   (IP Metric)   │
                  │                             └────────┬────────┘
                  │                                      │
                  │                                      ▼
                  │                             ┌─────────────────┐
                  │                             │  dist < 0.05?   │
                  │                             │ (95% similar?)  │
                  │                             └────────┬────────┘
                  │                                      │
                  │                      ┌───────────────┴───────────────┐
                  │                      │                               │
                  │                      ▼ YES                           ▼ NO
                  │           ┌─────────────────┐             ┌─────────────────┐
                  │           │    DUPLICATE    │             │   Upload New    │
                  │           │  Return existing│             │   Image to S3   │
                  │           │     S3 URL      │             └────────┬────────┘
                  │           └────────┬────────┘                      │
                  │                    │                               │
                  └────────────────────┼───────────────────────────────┘
                                       │
                                       ▼
                              ┌─────────────────┐
                              │ Return Response │
                              │  with S3 URL    │
                              └─────────────────┘
```

### 5.2 Generate Images Flow (Batch-4)

```
                              ┌─────────────────┐
                              │   API Request   │
                              │ /generate-images│
                              └────────┬────────┘
                                       │
                                       ▼
                         ┌─────────────────────────┐
                         │ product_type = "earring"?│
                         └─────────────┬───────────┘
                                       │
                    ┌──────────────────┴──────────────────┐
                    │                                      │
                    ▼ YES                                  ▼ NO
         ┌─────────────────┐                    ┌─────────────────┐
         │ image_types     │                    │ Use old prompt  │
         │ provided?       │                    │ system for      │
         └────────┬────────┘                    │ bracelet/neck   │
                  │                             └────────┬────────┘
       ┌──────────┴──────────┐                           │
       │                     │                           │
       ▼ YES                 ▼ NO                        │
┌─────────────┐    ┌─────────────────┐                   │
│ Use custom  │    │ Use default:    │                   │
│ image_types │    │ [1, 2, 4, 5]    │                   │
└──────┬──────┘    └────────┬────────┘                   │
       │                    │                            │
       └────────────────────┼────────────────────────────┘
                            │
                            ▼
              ┌───────────────────────────┐
              │   Fetch Original Image    │
              │        from S3            │
              └─────────────┬─────────────┘
                            │
                            ▼
              ┌───────────────────────────┐
              │  Generate Images (GPT)    │
              │  For each image_type:     │
              │  ├─ Type 1: White BG      │
              │  ├─ Type 2: Hand Holding  │
              │  ├─ Type 4: Lifestyle     │
              │  └─ Type 5: Model Wearing │
              └─────────────┬─────────────┘
                            │
                            ▼
              ┌───────────────────────────┐
              │   Upload to S3 + Create   │
              │        ZIP File           │
              └─────────────┬─────────────┘
                            │
                            ▼
              ┌───────────────────────────┐
              │      Return Response      │
              │  • gen_images: [...]      │
              │  • zip_url: "https://..." │
              └───────────────────────────┘
```

### 5.3 Caption Generation Flow

```
                              ┌─────────────────┐
                              │   API Request   │
                              │/generate_caption│
                              └────────┬────────┘
                                       │
                                       ▼
                         ┌─────────────────────────┐
                         │  Select S3 Bucket       │
                         │  (alya or blysk)        │
                         └─────────────┬───────────┘
                                       │
                                       ▼
                         ┌─────────────────────────┐
                         │ check_duplicate = "yes"? │
                         └─────────────┬───────────┘
                                       │
                    ┌──────────────────┴──────────────────┐
                    │ NO                                   │ YES
                    ▼                                      ▼
         ┌─────────────────┐                    ┌─────────────────┐
         │  Skip duplicate │                    │ Run duplicate   │
         │  check          │                    │ detection       │
         └────────┬────────┘                    └────────┬────────┘
                  │                                      │
                  │                           ┌──────────┴──────────┐
                  │                           │                     │
                  │                           ▼ DUPLICATE           ▼ NEW
                  │                ┌─────────────────┐    ┌─────────────────┐
                  │                │ Return existing │    │  Continue...    │
                  │                │ URL + "duplicate│    └────────┬────────┘
                  │                │ found"          │             │
                  │                └─────────────────┘             │
                  │                                                │
                  └────────────────────────────────────────────────┤
                                                                   │
                                       ┌───────────────────────────┘
                                       │
                                       ▼
                         ┌─────────────────────────┐
                         │    Upload to S3         │
                         │  (timestamp filename)   │
                         └─────────────┬───────────┘
                                       │
                                       ▼
                         ┌─────────────────────────┐
                         │   Index in Milvus       │
                         │   (for future search)   │
                         └─────────────┬───────────┘
                                       │
                                       ▼
                         ┌─────────────────────────┐
                         │   Analyze with Gemini   │
                         │   • Quality (A/B/C)     │
                         │   • Name                │
                         │   • Description         │
                         │   • Attributes          │
                         │   • Color               │
                         └─────────────┬───────────┘
                                       │
                                       ▼
                         ┌─────────────────────────┐
                         │    Return Response      │
                         │  {display_name, ...}    │
                         └─────────────────────────┘
```

### 5.4 Overall System Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              API SERVER                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐  │
│  │  /generate  │    │  /image_    │    │  /generate- │    │  /delete_   │  │
│  │  _caption   │    │  similarity │    │  images     │    │  image      │  │
│  │             │    │  _search    │    │             │    │             │  │
│  └──────┬──────┘    └──────┬──────┘    └──────┬──────┘    └──────┬──────┘  │
│         │                  │                  │                  │          │
│         └──────────────────┼──────────────────┼──────────────────┘          │
│                            │                  │                              │
│                            ▼                  ▼                              │
│              ┌─────────────────────────────────────────┐                    │
│              │           Core Services                  │                    │
│              ├─────────────────────────────────────────┤                    │
│              │  • CLIP Model (Image Embedding)         │                    │
│              │  • Gemini AI (Caption Generation)       │                    │
│              │  • GPT Image (Image Generation)         │                    │
│              └─────────────────────────────────────────┘                    │
│                            │                                                 │
└────────────────────────────┼─────────────────────────────────────────────────┘
                             │
          ┌──────────────────┼──────────────────┐
          │                  │                  │
          ▼                  ▼                  ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│   Milvus/Zilliz │ │    AWS S3       │ │   JSON Files    │
│  (Vector DB)    │ │  (Image Store)  │ │  (Hash Maps)    │
├─────────────────┤ ├─────────────────┤ ├─────────────────┤
│ • IP Metric     │ │ • alyaimg       │ │ • indexed_      │
│ • HNSW Index    │ │ • blyskimg      │ │   hashes.json   │
│ • 512-dim       │ │ • gen_images/   │ │ • int_hash_to_  │
│   vectors       │ │                 │ │   path.json     │
└─────────────────┘ └─────────────────┘ └─────────────────┘
```

---

## 6. Testing Guide

### Minimum Tests Before Deployment

| # | Test | Command | Expected |
|---|------|---------|----------|
| 1 | New image upload | `curl -X POST .../image_similarity_search -F "file=@new.jpg"` | `duplicate_found: false` |
| 2 | Duplicate detection | Upload same image again | `duplicate_found: true` |
| 3 | Caption generation | `curl -X POST .../generate_caption -F "file=@img.jpg" -F "type=earring"` | Full JSON response |
| 4 | Batch-4 generation | `curl -X POST .../generate-images -d '{"s3_urls":"...", "product_type":"earring"}'` | 4 images + ZIP |
| 5 | IP distance check | Check server logs | Distance values 0-1 range |

### Start Server

```bash
uvicorn img_to_csv:app --reload --host 0.0.0.0 --port 8000
```

---

## 7. Deployment Notes

### Important Reminders

| Item | Note |
|------|------|
| **Milvus Collection** | New collection: `image_embeddings_ip` |
| **Re-indexing** | May need to re-index all images for IP metric |
| **Environment** | Set `COLLECTION_NAME=image_embeddings_ip` |
| **Backwards Compatible** | `check_duplicate` and dual-bucket still work |

### Commits Made Today

| Commit | Description |
|--------|-------------|
| `0ff1d92` | Add composite approach for 100% jewelry preservation |
| `3f2834d` | Add image_types parameter for Amazon earrings catalog |
| `33bb046` | Add IP metric for duplicate detection |
| `8573238` | Add batch-4 image generation (skip dimension) |
| `0cc3fc7` | Add documentation |

---

*Document created: 5th February 2026*
